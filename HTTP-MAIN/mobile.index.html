<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
		<!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
		<title>Lifemap mobile</title>
		<!--meta for iphone-->
		<meta name="apple-itunes-app" content="app-id=1318716582, affiliate-data=myAffiliateData, app-argument=myURL">
  
		<meta name="twitter:card" content="app">
		<meta name="twitter:site" content="@lifemap_tol">
		<meta name="twitter:description" content="Lifemap is a tool to interactively explore the Tree of Life by zooming and panning in a manner similar to geographic maps. All nodes and tips of the tree are interactive. On click, a brief description and a picture of the group is displayed. This description is retrieved from Wikipedia. 
Lifemap also allows computing and visualizing the 'route' between two species or groups of species, or between any species and the root of the Tree of Life. ">
		<meta name="twitter:app:country" content="US">
		<meta name="twitter:app:name:googleplay" content="Lifemap - Tree of Life">
		<meta name="twitter:app:id:googleplay" content="fr.univ_lyon1.lifemapcom">
		<meta name="twitter:app:url:googleplay" content="https://play.google.com/store/apps/details?id=fr.univ_lyon1.lifemapcom&hl=fr">
		<!--ADD FAVICON -->
		<link rel="icon" type="image/png" href="img/LMicon1.png">
		<!-- Bootstrap -->
		<link href="css/bootstrap.min.css" rel="stylesheet">
		<!-- font awesome -->
		<link rel="stylesheet" href="js/font-awesome-4.6.1/css/font-awesome.min.css">
		<!-- leaflet -->
		<link rel="stylesheet" href="js/leaflet/leaflet.css" />
		<!--leaflet custom labels-->
		<link rel="stylesheet" href="js/labels/leaflet.label.css" />
		<!-- jqueryui -->
		<link href="js/searchbar/jquery-ui.css" rel="stylesheet">
		<!--map loading info-->
		<link rel="stylesheet" href="js/loading/Control.Loading.css" />

		<!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
		<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
		<!--[if lt IE 9]>
		<script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
		<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
		<![endif]-->

		<link rel="stylesheet" href="js/smartbanner.js/dist/smartbanner.css">

		<meta name="smartbanner:title" content="Lifemap - Tree of Life">
		<meta name="smartbanner:author" content="Damien de Vienne - LBBE">
		<meta name="smartbanner:price" content="FREE">
		<meta name="smartbanner:price-suffix-apple" content=" - On the App Store">
		<meta name="smartbanner:price-suffix-google" content=" - In Google Play">
		<meta name="smartbanner:icon-apple" content="img/resize_icon.png">
		<meta name="smartbanner:icon-google" content="img/resize_icon.png">
		<meta name="smartbanner:button" content="VIEW">
		<meta name="smartbanner:button-url-apple" content="https://itunes.apple.com/us/app/lifemap-tree-of-life/id1318716582?mt=8">
		<meta name="smartbanner:button-url-google" content="https://play.google.com/store/apps/details?id=fr.univ_lyon1.lifemapcom">
		<meta name="smartbanner:enabled-platforms" content="android,ios">
		<meta name="smartbanner:hide-ttl" content="10000">

		<style>
			body,html {
				height:100%;
			}
			.vcenter {
				display: inline-block;
				vertical-align: middle;
				float: none;
			}
			#searchinput {
				width: 100%;
				padding-left:10px;
				padding-right:30px;
				font-size:18px;
			}
			#searchclear {
				position: absolute;
				right: 10px;
				top: 0;
				bottom: 0;
				height: 14px;
				margin: auto;
				font-size: 14px;
				cursor: pointer;
				color: #585858;
			}
			/*
			#sandwich {
				position: absolute;
				left: 12px;
				top: 0;
				bottom: 0;
				height: 20px;
				margin: auto;
				font-size: 20px;
				cursor: pointer;
				color: #585858;
			}
			*/
			.routestick {
				box-shadow:1px 1px 2px 0.2px #656565;				
				background:white;
				padding-top: 5px;
				padding-bottom: 5px;
			}
			.papernote {
				box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);
				padding:10px;
				margin-top:15px;
				margin-bottom:15px;				
			}
			p {
				margin-bottom:0px;
			}
			.btn-circle {
				width: 50px;
				height: 50px;
				text-align: center;
				padding: 10px 0;
				font-size: 20px;
				line-height: 1.42;
				border-radius: 50%;
				position:absolute;
				background: #b4c3e0;
				color:white;
				border:0px;
				bottom:20px;
				right:15px;
				box-shadow: 0 0 10px black;
			}
			.btn-circle2 {
				width: 50px;
				height: 50px;
				padding:0px;
				background-color: transparent;
				text-align: center;
				position:absolute;
				border:0px;
				bottom:20px;
				left:15px;
				box-shadow: 0 0 10px black;
			}
			span.sciname {
				font-size:small;
				color: #505050;
				font-size:16px;
	    	}
	    	span.scinameItalic {
				font-style: italic;
				font-size:16px;
				color: #505050 ;	
	    	}
	    	span.commonname {
	    		color: #505050 ;
				font-size:16px;	
	    	}
	    	span.rank {
				text-transform: uppercase;
				font-weight: bolder;
				font-size:x-small;
				color: #989898 ;	
	    	}
		    .ui-autocomplete {
				background:white;
				border:0px;
				border-radius: 5px;
				margin-top:25px;
				max-height:72%;
				overflow-y: auto;
				overflow-x: hidden;
		 		box-shadow: 0 0 5px black;
				position:absolute;
			}
		</style>
	  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-80203455-1', 'auto');
  ga('send', 'pageview');

	</script>
	</head>
	<body style="background:black;">
		<!--MAP-->
		<div id="map" style="height:100%; z-index:0;"></div>
		<!--SIMPLE SEARCH DIV-->
		<div id="mainsearch" class="container-fluid" style="position: absolute; right:0px; left:0px; top:0px; background:transparent; margin: 10px 10px 0px 10px; padding:0px; z-index:10;">
			<div class="btn-group" style="width:100%;">
				<!--span id="sandwich" class="glyphicon glyphicon-menu-hamburger"></span>-->
				<input id="searchinput" type="search" class="form-control" style=" height:50px;" placeholder="Search species, clade, ...">
				<span id="searchclear" class="glyphicon glyphicon-remove"></span>
			</div>
		</div>
		<!--ITINERARY SEARCH BUTTON-->
		<a id="route" class="btn btn-default btn-circle">
			<i class="fa fa-level-up"></i>
		</a>
		<!--LOGO HELP BUTTON-->
		<a id="logohelp" class="btn btn-default btn-circle2">
			<img src="img/LMicon1.png" width="50px" height="50px"></i>
		</a>	
			
		<!-- ITINERARIES SEARCH DIV (TOP) -->
		<div id="route-top" class="container-fluid" style=" padding-left:15px; padding-right:35px; background:#b4c3e0; box-shadow: 0 0 10px black; position: absolute; right:0px; left:0px; top:0; z-index: 100;" hidden>
			<div class="row">&nbsp;</div>
			<div class="row">
				<div class="col-xs-2" style=" padding-left:0px; padding-right:0px;"><a id="back-to-map" class="btn" style="color:white;"><i class="fa fa-arrow-left"></i></a></div>
				<div class="col-xs-10" style="padding-left:0px;">
					<input id="searchinput2" type="search" class="form-control" placeholder="From species, clade...">
				</div>
			</div>
			<div class="row">&nbsp;</div>
			<div class="row">
				<div class="col-xs-2"></div>
				<div class="col-xs-10" style="padding-left:0px;">
					<input id="searchinput3" type="search" class="form-control" placeholder="To species, clade...">
				</div>
			</div>
			<div class="row">&nbsp;</div>
		</div>	

		<!--ITINERARY RESULTS DIV (BOTTOM)-->
		<div id="route-bottom" class="container-fluid" style="position: absolute; right:0px; left:0px; bottom:0; z-index:1000; background:white; box-shadow: 0 0 10px black;" hidden>
			<div class="row" style="padding:10px;">
				<div class="col-xs-8 vcenter">
					<div class="row"><i class="fa fa-map-marker fa-fw" style="color:#ffcc00; text-shadow: 1px 1px 1px #ccc;"></i><span id="routefrom"></span></div>	
					<div class="row"><i class="fa fa-ellipsis-v fa-fw" style="color:grey;"></i></div>
					<div id="mrcablock" hidden>
						<div class="row"><i class="fa fa-map-marker fa-fw" style="color:red; text-shadow: 1px 1px 1px #ccc;"></i><span style="font-size: xx-small; font-weight: bold; color:red;">MRCA </span><span id="routemrca" style="font-weight: bold; color:red;"></span></div>
						<div class="row"><i class="fa fa-ellipsis-v fa-fw" style="color:grey;"></i></div>
					</div>
					<div class="row"><i class="fa fa-map-marker fa-fw" style="color:blue; text-shadow: 1px 1px 1px #ccc;"></i><span id="routeto"></span></div>	
				</div><!--
				      --><div class="col-xs-2 vcenter"><a href="#" id="recenter" class="btn btn-lg" style="color:#b4c3e0;"><i class="fa fa-dot-circle-o"></i></a></div><!--
				      --><div class="col-xs-2 vcenter"><a href="#" id="getroutedetails" class="btn btn-lg" style="color:#b4c3e0;"><i class="fa fa-list"></i></a></div>
			</div>
		</div>
		<!--ITINERARY DETAILS DIV ///// TODO-->
		<div id="route-details" class="container-fluid" style="position: absolute; right:0px; left:0px; top:0px; min-height: 100%; z-index:2000; background:#fafafa; box-shadow: 0 0 10px black;" hidden>
			<div class="row" style="padding-top:10px; padding-right: 10px;">
				<div id="closedetails" class="col-xs-1 col-xs-offset-11">
					<i class="fa fa-times" style="color:black;"></i>
				</div>
			</div>
			<div id="details-content" class="row" style="padding:10px;">
			</div>
			<hr>
			<div class="row" style="padding-bottom: 20px;">
				<div class="col-xs-4 col-xs-offset-8">
					<button type="button" class="btn btn-default" id="closedetails2">Close</button>
				</div>
			</div>
		</div>

		<!--MODAL DIV THAT WILL CONTAIN THE DESCRIPTION OF THE SPECIES + PICTURES-->
		<div id="myModal" class="modal fade" role="dialog">
			<div class="modal-dialog">
				<!-- Modal content-->
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal">&times;</button>
						<div id="modaltitle" class="modal-title"></div>
					</div>
					<div class="modal-body">
							<div id="modalbody-text" style="font-size: x-small; padding: 5px"></div>
							<div id="modalbody-pict" style="box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);"></div>	
							<div id="modalbody-links" class="modal-body"></div>	
					</div>
					<div class="modal-footer">
						<div class="row"> 
							<div class="col-xs-6 text-center">
								<button type="button" id="viewfullancestry" class="btn btn-primary">View full ancestry</button>
							</div>
							<div class="col-xs-6 text-center">
								<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>

		<!--MODAL WITH THE MENU -->	
		<div class="modal fade" id="theMenu" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
						<h4 class="modal-title" id="myModalLabel"><img src = "img/logo1.png" width="50%"></h4>
					</div>
					<div class="modal-body text-justify" style="font-size: small;">
					<div class="papernote">
						<p><i class='fa fa-question-circle fa-fw fa-lg' style='color:grey;'></i>&nbsp;<b>Lifemap</b> is an interactive tool to explore the tree of life. The concept used in <b>Lifemap</b> is similar to the one used in cartography with tools like Google Maps© or Open Street Maps: exploring is done by zooming and panning.</p>
					</div>
					<div class="papernote">
						<p><i class='fa fa-info fa-fw  fa-lg' style='color:grey;'></i>&nbsp;The current tree contains 802639 species: 3733 Archaea, 277426 Bacteria and 521480 Eukaryotes. It is based on the taxonomy publised by the NCBI and updated regularly.</p>
					</div>
					<div class="papernote">
						<p><i class='fa fa-hand-pointer-o fa-fw fa-lg' style='color:grey;'></i>&nbsp;All the nodes in the tree are clickable. It displays information (description and picture) concerning the taxa (retrieved from the <i class='fa fa-wikipedia-w'></i>ikipedia page, if any). If you have description or pictures you would like to see in Lifemap, simply create or update the corresponding <i class='fa fa-wikipedia-w'></i>ikipedia page. </p>
					</div>
					<div class="papernote">
						<p><i class='fa fa-level-up fa-fw fa-lg' style='color:grey;'></i>&nbsp;Itineraries between taxa can be computed by clicking on the bottom right button of the main page and filling the two search fields. When filled, the route is drawn between the taxa, the Most Recent Common Ancestor (MRCA) of the two groups/species is returned. The user gets also access to a list of all the nodes that are encountered in the way from one group to the other. This list is clickable.</p>
					</div>
					<div class="papernote">
						<p><i class='fa fa-user fa-fw  fa-lg' style='color:grey;'></i>&nbsp;Lifemap was written by Damien M. de Vienne, a CNRS researcher working in the Laboratory of Biometry and Evolutionary Biology (LBBE) in Lyon (France) with support from the informatics departement (especially Stephane Delmotte and Bruno Spattaro). </p>
					</div>
					<p  style="font-size: x-small; text-align: center;"><i>For any question, remark, suggestion, or bug report, please contact Damien de Vienne: damien.de-vienne@univ-lyon1.fr</i><br>
					<a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc/4.0/80x15.png" /></a>&nbsp;<span xmlns:dct="http://purl.org/dc/terms/" property="dct:title">Lifemap</span> by <a xmlns:cc="http://creativecommons.org/ns#" href="https://lbbe.univ-lyon1.fr/en/annuaire-des-membres/de-vienne-damien" property="cc:attributionName" rel="cc:attributionURL">Damien de Vienne / CNRS</a> is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/">Creative Commons Attribution-NonCommercial 4.0 International License</a>.<br></p>
					<div class="modal-footer">					
				        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
					</div>
					</div>
				</div>
			</div>
		</div>


		<!-- SCRIPTS -->
		<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
		<script src="js/jquery-1.12.3.min.js"></script>
		<!-- Include all compiled plugins (below), or include individual files as needed -->
		<script src="js/bootstrap.min.js"></script>
		<!-- Include leaflet -->
		<script src="js/leaflet/leaflet.js"></script>
		<!--JQUERY UI -->
		<script src="js/searchbar/jquery-ui.js"></script>
		<!--JQUERY UI HTML AUTOCOMPLETE EXTENSION-->
		<script src="js/searchbar/jquery.ui.autocomplete.html.js"></script>
		<!--HERE IS WHAT CONCERNS THE MAP AND MAP FUNCTION (focus, etc...)-->
		<script>
			var map = L.map('map', {zoomControl: false, attributionControl: false});
			var tolUrl='http://umr5558-treezoom.univ-lyon1.fr/osm_tiles/{z}/{x}/{y}.png';
			var tol = new L.TileLayer(tolUrl, {minZoom: 2, maxZoom: 42});
			map.addLayer(tol);
			map.setView([-5,0], 4);

			map.on("moveend", function() {
				CreatePopUps();
			})
			map.on("click", function() {
				$("#searchinput").blur();
				$("#searchinput2").blur();
				$("#searchinput3").blur();
				//we also decide to toggle route information with a simple click. 
				if (map.hasLayer(polyline)) {
						$("#route-top").toggle();
						$("#route-bottom").toggle();
						//and also the itinerary button;						
						$("#route").toggle();
						$("#logohelp").toggle();
				}
				else {
					$("#mainsearch").toggle();
					$("#route").toggle();
					$("#logohelp").toggle();
				}

			})
			var SPfocus = L.marker([0,0]);
			var pointA = new L.LatLng(0,0);
			var pointB = new L.LatLng(1,1);
			var pointList = [pointA, pointB];
			var polyline = L.polyline(pointList);
			var markersRoute = new L.FeatureGroup();
			var markers = new L.FeatureGroup();
		</script>
		<!--VISUAL ELEMENTS (LOGOS, IMAGES, etc...)-->
		<script>
			var circl = L.icon({
				iconUrl: 'img/circl.png',
				iconSize:     [10, 10], // size of the icon
				iconAnchor:   [5, 5], // point of the icon which will correspond to marker's location
			});
			var mark = L.icon({
				iconUrl: 'img/mark.png',
				iconSize:     [20, 20], // size of the icon
				iconAnchor:   [10, 10], // point of the icon which will correspond to marker's location
			});

			var pin1 = L.icon({
				iconUrl: 'img/pin1.png',
				iconSize:     [18, 25], // size of the icon
				iconAnchor:   [9, 30], // point of the icon which will correspond to marker's location
			});
			var pin2 = L.icon({
				iconUrl: 'img/pin2.png',
				iconSize:     [18, 25], // size of the icon
				iconAnchor:   [9, 30], // point of the icon which will correspond to marker's location
			});
			var pin3 = L.icon({
				iconUrl: 'img/pin3.png',
				iconSize:     [18, 25], // size of the icon
				iconAnchor:   [9, 30], // point of the icon which will correspond to marker's location
			});
		</script>
		<!--INTERACTION (DIV SHOW/HIDE, FOCUS ON SE ETC.)-->
		<script>
			$("#route").click(function(){
				$("#route-top").show();
//				$("#route-suggestions").show();	
				$("#mainsearch").hide();		
				map.removeLayer(SPfocus);
				focusorgo();
			});
			$("#back-to-map").click(function(){
				$("#route-top").hide();
//				$("#route-suggestions").hide();	
				$("#route-bottom").hide();
				$("#mainsearch").show();
				map.removeLayer(markersRoute);
				map.removeLayer(polyline);
				//and we also clear the to and from variables
				taxidFrom = undefined; 
				taxidTo = undefined;
				//and we empty search fields
				$("#searchinput2").val('');
				$("#searchinput3").val('');
				$("#route").show();
				$("#logohelp").show();
			});
			$("#searchclear").click(function(){
				$("#searchinput").val('');
				$("#searchinput2").val('');
				$("#searchinput3").val('');
				taxidFrom = undefined;
				map.removeLayer(SPfocus);
			});
			$("#searchinput").focus(function() {
				$(this).autocomplete('search', $(this).val())
			})
			$("#searchinput2").focus(function() {
			    $("#route-bottom").hide();	
				$(this).autocomplete('search', $(this).val())
			})
			$("#searchinput3").focus(function() {
			    $("#route-bottom").hide();	
				$(this).autocomplete('search', $(this).val())
			})
			$("#searchinput2").keyup(function() {
				taxidFrom = undefined;
			});
			$("#searchinput3").keyup(function() {
				taxidTo = undefined;
			});
			$("#getroutedetails").click(function() {
				$("#route-details").show();
			});
			$("#closedetails").click(function() {
				$("#route-details").hide();
			});
			$("#closedetails2").click(function() {
				$("#route-details").hide();
			});
			$("#recenter").click(function() {
				mrcaroute();
			});
			$("#logohelp").click(function() {
				$("#theMenu").modal("toggle");
			})
			//HERE We create two variables that will be responsible for storing taxids of species from and two which roads may be computed
			var taxidFrom;
			var taxidTo;	
		</script>
		<!--MRCA-REALETED FUNCTIONS-->
		<script>
			function getMrca(a1, a2) {
	    	//we explore a1 and check if the value is present in a2.
	    	//if it is, we store both the corresponding indexes in a1 and a2 (and cut after?...)
	    		for (var i = 0; i < a1.length; i++) {
		    		if (a2.indexOf(a1[i]) != -1) {
			    		mrca = a1[i];
						break; 
				    }
			    }	
			    if (mrca===0) {mrca = 1;}
				return mrca;
			}
			function getRoute(a1, a2) {
	    		//we explore a1 and check if the value is present in a2.
	    		//if it is, we store both the corresponding indexes in a1 and a2 (and cut after?...)
	    		var res1 = [];
	    		var res2 = [];
	    		for (var i = 0; i < a1.length; i++) {
		    		res1.push(a1[i]);
		    		if (a2.indexOf(a1[i]) != -1) {
			    		var i2=a2.indexOf(a1[i]);
						break; 
					}
	    		}
			    for (var i = 0; i < i2; i++) {
				    res2.push(a2[i]);
			    }
				return res1.concat(res2.reverse());
		    }  
		    var zoomTo = function(taxid) {
				$("#route-details").hide();
		  		var url = 'http://umr5558-treezoom.univ-lyon1.fr/solr/solr/taxo/select?q=taxid:"'+taxid+'"&wt=json';
				if (taxid === 1) {
				  map.setView( L.latLng([-4.226497,0]),7);
				}
				else if (typeof taxid != 'undefined') {
			  		$.ajax({
						url : url,
						success : function(data) {
						var docs = JSON.stringify(data.response.docs);
						var jsonData = JSON.parse(docs);
						map.setView(jsonData[0].coordinates, jsonData[0].zoom);		    
					},
					dataType : 'jsonp',
					jsonp : 'json.wrf'
					});	    
				}
				else {
					alert('We could not Zoom to this location. \nPlease send and email to damien.de-vienne@univ-lyon1.fr explaining this issue and the taxid that was problematic.');
				}
			};
			//We create here the function that will build popups (modals).
			function CreatePopUps() {
			//we only remove markers that have their popup closed.
				map.removeLayer(markers);
				markers = new L.FeatureGroup();
				z = map.getZoom() + 4;
				bb = map.getBounds();
				var lon1 = bb._southWest.lng;
				var lon2 = bb._northEast.lng;
				var lat1 = bb._southWest.lat;
				var lat2 = bb._northEast.lat;
				var URL2 = "http://umr5558-treezoom.univ-lyon1.fr/solr/solr/taxo/select?q=*:*&fq=zoom:[0 TO " + z + "]&fq=lat:[" + lat1 + " TO " + lat2 + "]&fq=lon:[" + lon1 + " TO " + lon2 + "]&wt=json&rows=1000";
				$.ajax({
					url : URL2,
					success : function(data) {
						var ok = data.response.docs;
						$.each(ok, function( index, value ) {
							var latlong = new L.LatLng(ok[index].lat[0], ok[index].lon[0]);
							var marker = L.marker(latlong,{icon: mark});
							var str = ok[index].all;
							str=str.split("|");
							var spname = str[0];					  
							var comname = str[1];
							var rank = str[2];
							var taxid = str[3];
							marker.on("click", function() {
								markofun(taxid, spname, comname, rank);
							})
							markers.addLayer(marker);
							}
						);
					},
				dataType : 'jsonp',
				jsonp : 'json.wrf'
				});
				//We need to create something for the root as well.
				var marker = L.marker([-4.226497,0], {icon: mark, zIndexOffset:-1000});
				//create and bind content to marker (TODO)
				//bind marker to markers group
				markers.addLayer(marker);
				markers.addTo(map);
			}; 
		</script>
		<!--WIKIPEDIA RELATED FUNCTION-->
		<script>
			function getWikiDesc (spname) {
				var res = '';
				return $.getJSON(wikiurl="https://en.wikipedia.org/w/api.php?format=json&action=query&prop=extracts|pageimages&titles="+spname+"&redirects&exsentences=3&piprop=original|thumbnail|name&pithumbsize=300&callback=?").then(function(data){
					var page = data.query.pages;
					key = Object.keys(page)[0]
					if (key!="-1") {
						res = page[key];
						return res;
					}
					else {
						return null;
					}
				});
			}

		</script>


		<!--MAIN SEARCH FUNCTIONS (SINGLE AND ITINERARY)-->
		<script>
			//This little code fixes the width of the suggestions
			jQuery.ui.autocomplete.prototype._resizeMenu = function () {
	 			var ul = this.menu.element;
	 	 		ul.outerWidth(this.element.outerWidth());
			}
			//SEARCH FUNCTIONS
			$(function() {
				var str;
				var URL_PREFIX = "http://umr5558-treezoom.univ-lyon1.fr/solr/solr/taxo/suggesthandler?suggest.q=";
				var URL_PREFIX_FINAL = "http://umr5558-treezoom.univ-lyon1.fr/solr/solr/taxo/select?q=taxid:";
				var URL_SUFFIX = "&wt=json";
				$("#searchinput").autocomplete({
					source : function(request, response) {
						var URL = URL_PREFIX + $("#searchinput").val() + URL_SUFFIX;
						$.ajax({
							url : URL,
							success : function(data) {
								var step1=data.suggest.mySuggester[$("#searchinput").val()];
								var docs = JSON.stringify(step1.suggestions);
								var jsonData = JSON.parse(docs);
								jsonData.sort(function(a,b) {
									a1 = a.term.split("|")[0].replace(/<b>/g,"").replace(/<\/b>/g,"");
									b1 = b.term.split("|")[0].replace(/<b>/g,"").replace(/<\/b>/g,"");
									return(a1.length-b1.length);
								})
									response($.map(jsonData, function(value, key) {
										str = value.term;
										str=str.split("|");
										var issp = str[2];
										issp = issp.replace(/<b>/g,"");
										issp = issp.replace(/<\/b>/g,"");
										issp = issp.replace(" ","");
										issp = issp.replace(/[\x00-\x2f\x3a-\x40]/g,"");
										var taxid = str[3];
										taxid = taxid.replace(/<b>/g,"");
										taxid = taxid.replace(/<\/b>/g,"");
										taxid = taxid.replace(" ","");
										taxid = taxid.replace(/[\x00-\x2f\x3a-\x40]/g,"");
										var spname = str[0];
										spname=spname.replace(/<b>/g,"");
										spname=spname.replace(/<\/b>/g,"");
										var commonname = str[1];
										commonname=commonname.replace(/<b>/g,"");
										commonname=commonname.replace(/<\/b>/g,"");
										var renderval = spname + commonname;

										if ((issp==="species")||(issp==="subspecies")) {
											labOK = "<div style='border-bottom:1px solid #989898; padding: 20px;'><span class=\"scinameItalic\">" + str[0] + "</span><span class=\"commonname\">" + str[1] + "</span><br><span class=\"rank\" >" + str[2] + "</span></div>";			
										}
										else {
											labOK = "<div style='border-bottom:1px solid #989898; padding: 20px;'><span class=\"sciname\">" + str[0] + "</span><span class=\"commonname\">" + str[1] + "</span><br><span class=\"rank\">" + str[2] + "</span></div>";
										}
										return {
											label : labOK,
											value : renderval,
											taxidfinal: taxid,
											spname:spname,
											commonname:commonname,
											rank:issp											
										}
									}));
							},
							dataType : 'jsonp',
							jsonp : 'json.wrf'
						});
					},
					minLength : '1',
					autoFocus: false,
					html: true,
					focus: function() {
				    		// prevent value inserted on focus
				    		return false;
					},
					select: function(e, ui) {
						var taxidok = ui.item.taxidfinal;
						var spnameok = ui.item.spname;	
						var commonnameok = ui.item.commonname;
						var rankok = ui.item.rank;
						//We copy the search to the search box for the ways.
						$("#searchinput2").val(ui.item.value);
						//We store the taxid to variable taxidFrom.
						taxidFrom = taxidok;
						$("#searchinput").blur();						
						var URL = URL_PREFIX_FINAL + taxidok + URL_SUFFIX;
						$.ajax({
							url : URL,
							success : function(data) {
								map.removeLayer(SPfocus);
								var docs = JSON.stringify(data.response.docs);
								var jsonData = JSON.parse(docs);
								map.setView(jsonData[0].coordinates, jsonData[0].zoom-1);		    
								SPfocus = L.marker(jsonData[0].coordinates, {icon: pin1})								
								SPfocus.on("click", function() {
									markofun(taxidok, spnameok,commonnameok,rankok);
								})
								SPfocus.addTo(map);
							},
							dataType : 'jsonp',
							jsonp : 'json.wrf'
						});	    
					}
				})
			});
			$(function() {
				var str;
				var URL_PREFIX = "http://umr5558-treezoom.univ-lyon1.fr/solr/solr/taxo/suggesthandler?suggest.q=";
				var URL_PREFIX_FINAL = "http://umr5558-treezoom.univ-lyon1.fr/solr/solr/taxo/select?q=taxid:";
				var URL_SUFFIX = "&wt=json";
				$("#searchinput2").autocomplete({
					source : function(request, response) {
						var URL = URL_PREFIX + $("#searchinput2").val() + URL_SUFFIX;
						$.ajax({
							url : URL,
							position: { my: "left top", at: "left bottom", of: ".test" },
							success : function(data) {
								var step1=data.suggest.mySuggester[$("#searchinput2").val()];
								var docs = JSON.stringify(step1.suggestions);
								var jsonData = JSON.parse(docs);
								jsonData.sort(function(a,b) {
									a1 = a.term.split("|")[0].replace(/<b>/g,"").replace(/<\/b>/g,"");
									b1 = b.term.split("|")[0].replace(/<b>/g,"").replace(/<\/b>/g,"");
									return(a1.length-b1.length);
								})
								response($.map(jsonData, function(value, key) {
									str = value.term;
									str=str.split("|");
									var issp = str[2];
									issp = issp.replace(/<b>/g,"");
									issp = issp.replace(/<\/b>/g,"");
									issp = issp.replace(" ","");
									issp = issp.replace(/[\x00-\x2f\x3a-\x40]/g,"");
									var taxid = str[3];
									taxid = taxid.replace(/<b>/g,"");
									taxid = taxid.replace(/<\/b>/g,"");
									taxid = taxid.replace(" ","");
									taxid = taxid.replace(/[\x00-\x2f\x3a-\x40]/g,"");
									var spname = str[0];
									spname=spname.replace(/<b>/g,"");
									spname=spname.replace(/<\/b>/g,"");
									var commonname = str[1];
									commonname=commonname.replace(/<b>/g,"");
									commonname=commonname.replace(/<\/b>/g,"");
									var renderval = spname + commonname;

									if ((issp==="species")||(issp==="subspecies")) {
										labOK = "<div style='border-bottom:1px solid #989898; padding: 20px;'><span class=\"scinameItalic\">" + str[0] + "</span><span class=\"commonname\">" + str[1] + "</span><br><span class=\"rank\" >" + str[2] + "</span></div>";			
									}
									else {
										labOK = "<div style='border-bottom:1px solid #989898; padding: 20px;'><span class=\"sciname\">" + str[0] + "</span><span class=\"commonname\">" + str[1] + "</span><br><span class=\"rank\">" + str[2] + "</span></div>";
									}
									return {
										label : labOK,
										value : renderval,
										taxidfinal: taxid
									}
								}));
							},
							dataType : 'jsonp',
							jsonp : 'json.wrf'
						});
					},
					minLength : '1',
					autoFocus: false,
					html: true,
					focus: function() {
				    		// prevent value inserted on focus
				    		return false;
					},
					select: function(e, ui) {
						var taxidok = ui.item.taxidfinal;			    
						//We store the taxid to variable taxidFrom
						taxidFrom = taxidok;
						$("#searchinput2").blur();
						focusorgo();
					}, 
				})
			});
			$(function() {
				var str;
				var URL_PREFIX = "http://umr5558-treezoom.univ-lyon1.fr/solr/solr/taxo/suggesthandler?suggest.q=";
				var URL_PREFIX_FINAL = "http://umr5558-treezoom.univ-lyon1.fr/solr/solr/taxo/select?q=taxid:";
				var URL_SUFFIX = "&wt=json";
				$("#searchinput3").autocomplete({
					source : function(request, response) {
						var URL = URL_PREFIX + $("#searchinput3").val() + URL_SUFFIX;
						$.ajax({
							url : URL,
							position: { my: "left top", at: "left bottom", of: ".test" },
							success : function(data) {
								var step1=data.suggest.mySuggester[$("#searchinput3").val()];
								var docs = JSON.stringify(step1.suggestions);
								var jsonData = JSON.parse(docs);
								jsonData.sort(function(a,b) {
									a1 = a.term.split("|")[0].replace(/<b>/g,"").replace(/<\/b>/g,"");
									b1 = b.term.split("|")[0].replace(/<b>/g,"").replace(/<\/b>/g,"");
									return(a1.length-b1.length);
								})
								response($.map(jsonData, function(value, key) {
									str = value.term;
									str=str.split("|");
									var issp = str[2];
									issp = issp.replace(/<b>/g,"");
									issp = issp.replace(/<\/b>/g,"");
									issp = issp.replace(" ","");
									issp = issp.replace(/[\x00-\x2f\x3a-\x40]/g,"");
									var taxid = str[3];
									taxid = taxid.replace(/<b>/g,"");
									taxid = taxid.replace(/<\/b>/g,"");
									taxid = taxid.replace(" ","");
									taxid = taxid.replace(/[\x00-\x2f\x3a-\x40]/g,"");
									var spname = str[0];
									spname=spname.replace(/<b>/g,"");
									spname=spname.replace(/<\/b>/g,"");
									var commonname = str[1];
									commonname=commonname.replace(/<b>/g,"");
									commonname=commonname.replace(/<\/b>/g,"");
									var renderval = spname + commonname;

									if ((issp==="species")||(issp==="subspecies")) {
										labOK = "<div style='border-bottom:1px solid #989898; padding: 20px;'><span class=\"scinameItalic\">" + str[0] + "</span><span class=\"commonname\">" + str[1] + "</span><br><span class=\"rank\" >" + str[2] + "</span></div>";			
									}
									else {
										labOK = "<div style='border-bottom:1px solid #989898; padding: 20px;'><span class=\"sciname\">" + str[0] + "</span><span class=\"commonname\">" + str[1] + "</span><br><span class=\"rank\">" + str[2] + "</span></div>";
									}
									return {
										label : labOK,
										value : renderval,
										taxidfinal: taxid
									}
								}));
							},
							dataType : 'jsonp',
							jsonp : 'json.wrf'
						});
					},
					minLength : '1',
					autoFocus: false,
					html: true,
					focus: function() {
				    		// prevent value inserted on focus
				    		return false;
					},
					select: function(e, ui) {
						var taxidok = ui.item.taxidfinal;			    
						taxidTo = taxidok;
						$("#searchinput3").blur();
						focusorgo();
					}
				})
			});
		
			//Now we create a function that will handle the fact 
			//that the focus is always on the search box that is empty, and that when both are full, 
			//we start computing the route, etc...
			function focusorgo() {
				if ((taxidTo===undefined)&&(taxidFrom!=undefined)) {
					$("#searchinput3").focus();
				}
				else if ((taxidFrom===undefined)&&(taxidTo!=undefined)) {
					$("#searchinput2").focus();
				}
				else if ((taxidFrom===undefined)&&(taxidTo===undefined)) {
					$("#searchinput2").focus();
				}
				else { //Both are defined. We can go for it: search path etc.
					mrcaroute();
				}
			}
			function mrcaroute() {
				map.removeLayer(SPfocus);
				//get infos
				taxidFrom = taxidFrom.replace(/\s+/g, '');
				taxidTo = taxidTo.replace(/\s+/g, '');
				console.log(taxidFrom);
				console.log(taxidTo);				
				var url = 'http://umr5558-treezoom.univ-lyon1.fr/solr/solr/addi/select?q=*:*&fq=taxid:('+taxidFrom+' '+taxidTo+')&wt=json';
				$.ajax({
				    url : url,
				    success : function(data) {
				    	console.log("oui");
				    	console.log(taxidFrom);
						console.log(taxidTo);	
					    var res = data.response.docs;
						var asc1 = res[0].ascend;
						asc1 = [parseInt(res[0].taxid)].concat(asc1);
						if ((taxidFrom==='1')||(taxidTo==='1')) {
							var route = asc1;
							var asc2 = [0];
						}
						else { 
							var asc2 = res[1].ascend;
							asc2 = [parseInt(res[1].taxid)].concat(asc2);
						    var route = getRoute(asc1,asc2);
						}
						if (taxidFrom!=res[0].taxid[0]) {
								route = route.reverse();
						}
						var mrca = getMrca(asc1,asc2);
						routeq = route.toString().replace(/,/g,' ');
						console.log("routeq");
						console.log(routeq);
						url2 = 'http://umr5558-treezoom.univ-lyon1.fr/solr/solr/taxo/select?q=*:*&fq=taxid:(' + routeq + ')&wt=json&rows=10000';

						$.ajax({
						    url : url2,
						    success: function(data2) {
    				    	console.log("oui2");
    				    	console.log(taxidFrom);
							console.log(taxidTo);	
							map.removeLayer(markersRoute);
							map.removeLayer(polyline);
							$("#details-content").empty();
							markersRoute = new L.FeatureGroup();
							//we get taxid order of this new list (different from the input order asked to solr
							dataok = data2.response.docs;
							//we try to put dataok in the original order
							var neworder = [];
							for (var j=0;j < dataok.length; j++) {
							    neworder[j] = dataok[j].taxid[0];
							}
							//we will store lat and longs here 
							latlngs = [];
							names = [];
							taxids = [];
							ranks = [];
							commons = [];
							for (j=0;j < route.length; j++) {
							    if (route[j]===0) { //we pass by the root
									latlngs[j] = L.latLng([-4.226497,0]);
									names[j] = "Root";
									taxids[j] = 1;
									ranks[j] = "Root";
									commons[j] = " ";
							    }
							    else {
									var where = neworder.indexOf(route[j]);
									latlngs[j] = L.latLng([dataok[where].lat[0],dataok[where].lon[0]]);
									names[j] = dataok[where].sci_name;
									taxids[j] = (dataok[where].taxid)[0];
									ranks[j] = (dataok[where].rank)[0];
									commons[j] = dataok[where].common_name;
									if (commons[j]===undefined) {commons[j] = " ";}
									else {commons[j] = " "+commons[j]+" ";}
							    }
							    var mark = L.marker(latlngs[j], {icon: circl, clickable:false}).setOpacity(0.6).addTo(map);
							    markersRoute.addLayer(mark);
							}
							var mrcaindex = taxids.indexOf(mrca);
							var sp1 = L.marker(latlngs[0], {icon: pin1});
							sp1.on("click", function() {
								markofun(taxids[0], names[0],commons[0], ranks[0]);
							})	
							markersRoute.addLayer(sp1);
							var sp2 = L.marker(latlngs[latlngs.length-1], {icon: pin3});
							sp2.on("click", function() {
								markofun(taxids[latlngs.length-1], names[latlngs.length-1],commons[latlngs.length-1], ranks[latlngs.length-1]);
							})	
							markersRoute.addLayer(sp2);
							if ((mrcaindex!=0)&&(mrcaindex!=(names.length-1))) { //case where there is no mrca (one of the clade is the mrca)
							    var spmrca = L.marker(latlngs[mrcaindex], {icon: pin2});
							    spmrca.on("click", function() {
									markofun(taxids[mrcaindex], names[mrcaindex],commons[mrcaindex], ranks[mrcaindex]);
								})
							    markersRoute.addLayer(spmrca);							    
   							    $("#routemrca").empty();
							    $("#routemrca").append(names[mrcaindex]);
   							    $("#mrcablock").show();	
								for (i=0;i<names.length;i++) {
									ht = "<div class='col-xs-12 vcenter' onclick='javascript:zoomTo("+taxids[i]+");'>";
									if (i!=0) {ht+= "<div class='row'><i class='fa fa-ellipsis-v fa-fw fa-lg' style='color:grey;'></i></div>";}
									if (i===0) { //from 
										ht+="<div class='row routestick'><i class='fa fa-map-marker fa-fw fa-lg' style='color:#ffcc00; text-shadow: 1px 1px 1px #ccc;'></i><span class='sciname'>"+names[i]+"</span>&nbsp<span class='rank'>"+ranks[i]+"</span></div>";
										ht+="</div>" //close xs-10 column
									}
									else if (i===mrcaindex) { //to
										ht+="<div class='row  routestick'><i class='fa fa-map-marker fa-fw fa-lg' style='color:red; text-shadow: 1px 1px 1px #ccc;'></i><span class='sciname'>"+names[i]+"</span>&nbsp<span class='rank'>"+ranks[i]+"</span></div>";
									}
									else if (i===(names.length-1)) { //to
										ht+="<div class='row routestick'><i class='fa fa-map-marker fa-fw fa-lg' style='color:blue; text-shadow: 1px 1px 1px #ccc;'></i><span class='sciname'>"+names[i]+"</span>&nbsp<span class='rank'>"+ranks[i]+"</span></div>";
									}
									else { //intermediate nodes
										ht+="<div class='row routestick'><i class='fa fa-caret-right fa-fw fa-lg' style='color:grey;'></i><span class='sciname'>"+names[i]+"</span>&nbsp<span class='rank'>"+ranks[i]+"</span></div>";	
									}
									$("#details-content").append(ht);
								}
							}
							else {
								$("#mrcablock").hide();	
								for (i=0;i<names.length;i++) {
									ht = "<div class='col-xs-12 vcenter' onclick='javascript:zoomTo("+taxids[i]+");'>";
									if (i!=0) {ht+= "<div class='row'><i class='fa fa-ellipsis-v fa-fw' style='color:grey;'></i></div>";}
									if (i===0) { //from 
										ht+="<div class='row routestick'><i class='fa fa-map-marker fa-fw fa-lg' style='color:#ffcc00; text-shadow: 1px 1px 1px #ccc;'></i><span class='sciname'>"+names[i]+"</span>&nbsp<span class='rank'>"+ranks[i]+"</span></div>";
										ht+="</div>" //close xs-10 column
									}
									else if (i===(names.length-1)) { //to
										ht+="<div class='row routestick'><i class='fa fa-map-marker fa-fw fa-lg' style='color:blue; text-shadow: 1px 1px 1px #ccc;'></i><span class='sciname'>"+names[i]+"</span>&nbsp<span class='rank'>"+ranks[i]+"</span></div>";
									}
									else { //intermediate nodes
										ht+="<div class='row routestick'><i class='fa fa-caret-right fa-fw fa-lg' style='color:grey;'></i><span class='sciname'>"+names[i]+"</span>&nbsp<span class='rank'>"+ranks[i]+"</span></div>";	
									}
									$("#details-content").append(ht);
								}

							}
							polyline = L.polyline(latlngs, {color: 'red', clickable:false, weight:6});
							polyline.addTo(map);
							if (focus) map.fitBounds(polyline.getBounds(), {paddingTopLeft:[20,140], paddingBottomRight:[0,120]});
							markersRoute.addTo(map);
							$("#routefrom").empty();
							$("#routeto").empty();
							$("#routefrom").append(names[0]);
							$("#routeto").append(names[names.length-1]);
							$("#route-bottom").show();
						    },
						    dataType : 'jsonp',
						    jsonp : 'json.wrf'
							});
					},
		    		dataType : 'jsonp',
		    		jsonp : 'json.wrf'
		    	})};
			
		</script>
		<script>
		function markofun(taxid, spname,comname, rank) {
			taxi = taxid;
			spna = spname;
			comna = comname;
			console.log(rank);
			$('#modaltitle').empty();
			$('#modalbody-text').empty();	
			$('#modalbody-pict').empty();
			$('#modalbody-links').empty();	
		    if ((rank==="species")||(rank===" species ")) {
				$('#modaltitle').append("<span class='scinameItalic'>"+spname+"</span>");	
		    }
		    else {
				$('#modaltitle').append("<span class='sciname'>"+spname+"</span>");	
			}
			$('#modaltitle').append("<span class='commonname'>"+comname+"</span>");
			$('#modaltitle').append("<span class='rank'>"+rank+"</span>");	
			text = "<div style='font-style:center; color:grey;'>No article concerning this group on <i class='fa fa-wikipedia-w'></i>ikipedia.</div>";
			pict = "";
			if (spname!="Root") {
				getWikiDesc(spname).then(function(resu){
					if (resu!=null) {
						text = '<div>' + resu.extract + '</div>';
						text += "<div style='padding-bottom:10px;text-align:right; font-size:xx-small;'><a href='https://en.wikipedia.org/wiki/" + spname + "' target='_blank'>more on <i class='fa fa-wikipedia-w'></i>ikipedia</a><br></div>";
						$('#modalbody-text').append(text);	
						if (resu.thumbnail!==undefined) {
							//we add the image to the popup
							pict = '<div><a href="https://en.wikipedia.org/wiki/' + spname + '" target="_blank"><img src ='+resu.thumbnail.source+' width="100%"></a></div>'
							$('#modalbody-pict').append(pict);
						}
						else {
							pict = "<div style='padding:10px; font-size:xx-small; text-align:center; color:grey;'> No picture associated to this articlke on Wikipedia. Click <a href='https://en.wikipedia.org/wiki/" + spname + "' target='_blank'>here</a> if you want to upload one now.</div>";
							$('#modalbody-pict').append(pict);
						}
					}
					else {
						$('#modalbody-text').append(text);
						$('#modalbody-pict').append(pict);
					}
				})
			}
			$('#myModal').modal('show');
			$('#viewfullancestry').on("click", function() {
				taxidFrom = taxi;
				taxidTo = "1";
				$("#myModal").modal("hide");
				$("#mainsearch").hide();					
				$('#searchinput2').val(spna + comna);
				$('#searchinput3').val('Root');
				$("#route-top").show();
				mrcaroute();
			})
		};
		</script>
		<script src="js/smartbanner.js/dist/smartbanner.min.js"></script>

	</body>
</html>
